{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Deploys Splunk instances in given VPC and subnets",
  "Metadata": {
      "AWS::CloudFormation::Interface": {
          "ParameterGroups": [

              {
                  "Label": {
                      "default": " Splunk Instance Configuration "
                  },
                  "Parameters": [

                             "KeyName",
                             "SplunkAdminPassword",
                             "SplunkClusterSecret",
                             "SplunkIndexerDiscoverySecret",
                             "SplunkReplicationFactor",
                             "InstanceTenancy"

                  ]
              }
          ]
      }

  },

  "Parameters" : {
         "KeyName": {
           "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
           "Type": "AWS::EC2::KeyPair::KeyName",
           "MinLength": "1",
           "MaxLength": "255",
           "AllowedPattern" : "[\\x20-\\x7E]*",
           "ConstraintDescription" : "can contain only ASCII characters."
         },
         "SplunkReplicationFactor": {
             "ConstraintDescription": "must be a valid number, 2-5",
             "Default": "3",
             "Description": "How many copies of data should be stored in the Splunk clusters",
             "MaxValue": "5",
             "MinValue": "2",
             "Type": "Number"
         },
         "SplunkClusterSecret": {
             "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
             "ConstraintDescription": "Must be at least 8 characters containing letters, numbers and symbols.",
             "Description": "Shared cluster secret for Search Head and Indexer cluster nodes. Must be at least 8 characters containing letters, numbers and symbols.",
             "MaxLength": "32",
             "MinLength": "8",
             "NoEcho": "true",
             "Type": "String"
         },

         "SplunkIndexerDiscoverySecret": {
             "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
             "ConstraintDescription": "Must be at least 8 characters containing letters, numbers and symbols.",
             "Description": "Security key used for communication between your forwarders and the cluster master. This value should also be used by forwarders in order to retrieve list of available peer nodes from cluster master. Must be at least 8 characters containing letters, numbers and symbols.",
             "MaxLength": "32",
             "MinLength": "8",
             "NoEcho": "true",
             "Type": "String"
         },

            "SplunkAdminPassword": {
            "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
            "ConstraintDescription": "Must be at least 8 characters containing letters, numbers and symbols.",
            "Description": "Admin password for Splunk. Must be at least 8 characters containing letters, numbers and symbols.",
            "MaxLength": "32",
            "MinLength": "6",
            "NoEcho": "true",
            "Type": "String"
        },

        "InstanceTenancy" :{
            "Description" : "Tenancy EC2",
            "Type" : "String",
            "AllowedValues":["default","dedicated","host"]
         },

            "NumberOfAZs": {
             "AllowedValues": [
                 "2"

             ],
             "Default": "2",
             "Description": "Number of Availability Zones to use in the VPC. This must match the number public subnet IDs entered as parameters",
             "Type": "String"
         }
   },
   "Conditions": {
        "Create2AZ": {
            "Fn::Equals": [
                {
                    "Ref": "NumberOfAZs"
                },
                "2"
            ]
        }
      },

     "Mappings":{
        "SplunkConfig": {
      "shcluster-replication-factor": {
          "num": "2"
      },
      "labels": {
          "cluster": "IndexerCluster",
          "shcluster": "SearchHeadCluster"
      }
  }
},

  "Resources" : {

    "Indexer1NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",

     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.1",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-indexer-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "Indexer1Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX1 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX1 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-a07b8aeb",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer1Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },

        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer1NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer1EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer1st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer1st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-indexer-01-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer1EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer1-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer1st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer1-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer1st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer1-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },

    "Indexer2NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-8ce902c7",
       "PrivateIpAddress": "10.219.23.1",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2b-prd-splunk-indexer-02-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },

    "Indexer2Instance" : {
      "Type" : "AWS::EC2::Instance",
       "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},

        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX2 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX2 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-2ef02657",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer2Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer2NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer2EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer2st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer2st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2b-prd-splunk-indexer-02-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer2EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2b",

         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer2-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer2st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer2-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer2st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer2-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },
    "Indexer3NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.2",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-indexer-03-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "Indexer3Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX3 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX3 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-a07b8aeb",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer3Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer3NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer3EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer3st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer3st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-indexer-03-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer3EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer3-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer3st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer3-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer3st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer3-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },
    "Indexer4NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-8ce902c7",
       "PrivateIpAddress": "10.219.23.2",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2b-prd-splunk-indexer-04-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "Indexer4Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX4 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX4 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-2ef02657",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer4Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer4NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer4EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer4st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer4st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2b-prd-splunkindexer1-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer4EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer4-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer4st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer4-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer4st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer4-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },
    "Indexer5NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.3",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-indexer-05-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "Indexer5Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX5 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX5 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-a07b8aeb",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer5Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },

        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer5NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer5EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer5st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer5st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-indexer-05-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer5EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer5-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer5st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer5-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer5st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunkindexer5-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },
    "Indexer6NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-8ce902c7",
       "PrivateIpAddress": "10.219.23.3",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2b-prd-splunk-indexer-06-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "Indexer6Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                     "Fn::Base64": {
                         "Fn::Join": [
                             "",
                             [
                                 "#!/bin/bash -v\n",
                                 "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                 "chmod 600 /var/log/cloud-init-output.log\n",
                                 "yum update -y aws-cfn-bootstrap\n",
                                 "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                 "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                 "export SPLUNK_USER=splunk\n",
                                 "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                 "export SPLUNK_HOME=/opt/splunk\n",
                                 "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkIDX6 ' >> /etc/hosts\n",
                                 "hostname AWS-SplunkIDX6 \n",
                                 "# Stop Splunk and reset password\n",
                                 "service splunk stop\n",
                                 "touch $SPLUNK_HOME/etc/.ui_login\n",
                                 "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                 "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 " -role admin -auth admin:changeme\n",
                                 "# Increase splunkweb connection timeout with splunkd\n",
                                 "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                 "[settings]\n",
                                 "splunkdConnectionTimeout = 300\n",
                                 "end\n",
                                 "# Configure some SHC parameters\n",
                                 "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                                 "[shclustering]\n",
                                 "register_replication_address = ${LOCALIP}\n",
                                 "end\n",
                                 "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                 "service splunk start\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 -auth admin:",
                                 {
                                     "Ref": "SplunkAdminPassword"
                                 },
                                 "\n",
                                 "export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)\n",
                                 "export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)\n",
                                 "case $INSTANCE_SUBNET_ID in\n",
                                 "subnet-2ef02657",

                                 ")\n",
                                 "    site=\"site1\"\n",
                                 "    ;;\n",
                                 "  ",


                                 "  *)\n",
                                 "    echo \"Unexpected subnet id\"\n",
                                 "    exit 1\n",
                                 "esac\n",
                                 "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode slave",
                                 " -site $site",
                                 " -master_uri https://",
                                 {
                                     "Fn::GetAtt": [
                                         "ManagementServerInstance",
                                         "PrivateIp"
                                     ]
                                 },
                                 ":8089 ",
                                 " -replication_port 9887",
                                 " -secret ",
                                 {
                                     "Ref": "SplunkClusterSecret"
                                 },
                                 "\n",
                                 "service splunk restart\n",
                                 "/opt/aws/bin/cfn-signal -s true --stack ",
                                 {
                                     "Ref": "AWS::StackName"
                                 },
                                 " --resource Indexer6Instance",
                                 " --region ",
                                 {
                                     "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "usermod --expiredate 1 splunk\n"
                             ]
                         ]
                     }
                 },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "Indexer6NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer6EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer6st1volume1" },
                                                                      "Device" : "/dev/sdc"
                                                              },
                                                              {
                                                                      "VolumeId" : { "Ref" : "Indexer6st1volume2" },
                                                                      "Device" :  "/dev/sdd"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2b-prd-splunk-indexer-06-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "Indexer6EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "2500",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer6-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},
    "Indexer6st1volume1": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer6-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

			}
		},
    "Indexer6st1volume2": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "10750",
         "VolumeType" :"st1",
         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunkindexer6-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]

      }
    },
    "ESNIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.4",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-es-search-head-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "ESSearchHeadInstance" : {
      "Type" : "AWS::EC2::Instance",
       "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "m4.10xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},

        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                "chmod 600 /var/log/cloud-init-output.log\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                "export SPLUNK_USER=splunk\n",
                                "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                "export SPLUNK_HOME=/opt/splunk\n",
                                "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkESSH' >> /etc/hosts\n",
                                "hostname AWS-SplunkESSH\n",
                                "# Stop Splunk and reset password\n",
                                "service splunk stop\n",
                                "touch $SPLUNK_HOME/etc/.ui_login\n",
                                "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                " -role admin -auth admin:changeme\n",
                                "# Increase splunkweb connection timeout with splunkd\n",
                                "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                                "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                                "[settings]\n",
                                "splunkdConnectionTimeout = 300\n",
                                "end\n",
                                "# Forward to indexer cluster using indexer discovery\n",
                                "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/outputs.conf <<end\n",
                                "# Turn off indexing on the search head\n",
                                "[indexAndForward]\n",
                                "index = false\n",
                                "\n",
                                "[tcpout]\n",
                                "defaultGroup = indexer_cluster_peers\n",
                                "forwardedindex.filter.disable = true\n",
                                "indexAndForward = false\n",
                                "\n",
                                "[tcpout:indexer_cluster_peers]\n",
                                "autoLB = true\n",
                                "indexerDiscovery = cluster_master\n",
                                "\n",
                                "[indexer_discovery:cluster_master]\n",
                                "pass4SymmKey = ",
                                {
                                    "Ref": "SplunkIndexerDiscoverySecret"
                                },
                                "\n",
                                "master_uri = https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089\n",
                                "end\n",
                                "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                                "service splunk start\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave -master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 -auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                " -mode searchhead -site site1 -master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 -auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",

                                "service splunk restart\n",
                                "/opt/aws/bin/cfn-signal -e $? --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " --resource ESSearchHeadInstance",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "usermod --expiredate 1 splunk\n"
                            ]
                        ]
                    }
                },



        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "ESNIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "ESEBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-es-search-head-01-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Indexer"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "ESEBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "300",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-es-search-head-01-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Indexer"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},

    "OPSSearchHead1NIC" : {

     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.5",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-ops-search-head-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk OPS Search Head"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },
                                                                   {
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
      "OPSSearchHead1Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "c4.4xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},
        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                "chmod 600 /var/log/cloud-init-output.log\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                "export SPLUNK_USER=splunk\n",
                                "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                "export SPLUNK_HOME=/opt/splunk\n",
                                "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkSHC1 ' >> /etc/hosts\n",
                                "hostname AWS-SplunkSHC1 \n",
                                "# Stop Splunk and reset password\n",
                                "service splunk stop\n",
                                "touch $SPLUNK_HOME/etc/.ui_login\n",
                                "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                " -role admin -auth admin:changeme\n",
                                "# Increase splunkweb connection timeout with splunkd\n",
                                "cat >$SPLUNK_HOME/etc/system/local/web.conf <<end\n",
                                "[settings]\n",
                                "splunkdConnectionTimeout = 300\n",
                                "end\n",
                                "# Configure some SHC parameters\n",
                                "cat >>$SPLUNK_HOME/etc/system/local/server.conf <<end\n",
                                "[shclustering]\n",
                                "register_replication_address = $LOCALIP\n",
                                "end\n",
                                "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local\n",
                                "service splunk start\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave ",
                                "-master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN init shcluster-config ",
                                "-mgmt_uri https://$LOCALIP:8089 -replication_port 8090 -replication_factor ",
                                {
                                    "Fn::FindInMap": [
                                        "SplunkConfig",
                                        "shcluster-replication-factor",
                                        "num"
                                    ]
                                },
                                " -conf_deploy_fetch_url https://",
                                {
                                    "Fn::GetAtt": [
                                        "DeploymentServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-shcluster_label SplunkSHC ",
                                "-secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                " ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode searchhead",
                                " -site site1",
                                " -master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                " -secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                "\n",
                                "service splunk restart\n",
                                "/opt/aws/bin/cfn-signal -e $? --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " --resource OPSSearchHead1Instance",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "usermod --expiredate 1 splunk\n"
                            ]
                        ]
                    }
                },

          "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "OPSSearchHead1NIC" }, "DeviceIndex" : "0" }
                                              ],
                                              "Volumes" : [

                                                                      {
                                                                              "VolumeId" : { "Ref" : "OPSSearchHead1EBSvolume" },
                                                                              "Device" :  "/dev/sdb"
                                                                      }


                                                              ],

                                                                "Tags": [{
                                                                                                  "Key": "Name",
                                                                                                  "Value": "stx-uw2-2b-prd-splunk-ops-search-head-01-ec2"
                                                                                          },
                                                                                          {
                                                                                                  "Key": "ApplicationRole",
                                                                                                  "Value": "Splunk OPS Search Head"
                                                                                                },
                                                                                                {
                                                                                                        "Key": "Cluster",
                                                                                                        "Value": "NA"
                                                                                                      },
                                                                                                      {
                                                                                                              "Key": "Environment",
                                                                                                              "Value": "Production"
                                                                                                            },
                                                                                                            {
                                                                                                                    "Key": "Version",
                                                                                                                    "Value": "6.6.2"
                                                                                                                  },
                                                                                                                 {
                                                                                                                          "Key": "OperatingSystem",
                                                                                                                          "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                        },
                                                                                                                        {
                                                                                                                                "Key": "Owner",
                                                                                                                                "Value": "Kevin McLellan"
                                                                                                                              },
                                                                                                                              {
                                                                                                                                      "Key": "BusinessUnit",
                                                                                                                                      "Value": "NA"
                                                                                                                                    },
                                                                                                                                    {
                                                                                                                                            "Key": "Compliance",
                                                                                                                                            "Value": "NA"
                                                                                                                                          },{
                                                                                                                                                  "Key": "Backup",
                                                                                                                                                  "Value": "False"
                                                                                                                                                }

                                                                                        ]



            }
        },



    "OPSSearchHead1EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "300",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-ops-search-head-01-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk ES Search Head"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]
			}
		},

    "OPSSearchHead2NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-8ce902c7",
       "PrivateIpAddress": "10.219.23.4",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2b-prd-splunk-ops-search-head-02-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Indexer"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": ""
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "OPSSearchHead2Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "c4.4xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                "chmod 600 /var/log/cloud-init-output.log\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                "export SPLUNK_USER=splunk\n",
                                "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                "export SPLUNK_HOME=/opt/splunk\n",
                                "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkSHC2' >> /etc/hosts\n",
                                "hostname AWS-SplunkSHC2\n",
                                "# Stop Splunk and reset password\n",
                                "service splunk stop\n",
                                "touch $SPLUNK_HOME/etc/.ui_login\n",
                                "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                " -role admin -auth admin:changeme\n",
                                "# Increase splunkweb connection timeout with splunkd\n",
                                "cat >$SPLUNK_HOME/etc/system/local/web.conf <<end\n",
                                "[settings]\n",
                                "splunkdConnectionTimeout = 300\n",
                                "end\n",
                                "# Configure some SHC parameters\n",
                                "cat >>$SPLUNK_HOME/etc/system/local/server.conf <<end\n",
                                "[shclustering]\n",
                                "register_replication_address = $LOCALIP\n",
                                "end\n",
                                "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local\n",
                                "service splunk start\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave ",
                                "-master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN init shcluster-config ",
                                "-mgmt_uri https://$LOCALIP:8089 -replication_port 8090 -replication_factor ",
                                {
                                    "Fn::FindInMap": [
                                        "SplunkConfig",
                                        "shcluster-replication-factor",
                                        "num"
                                    ]
                                },
                                " -conf_deploy_fetch_url https://",
                                {
                                    "Fn::GetAtt": [
                                        "DeploymentServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-shcluster_label SplunkSHC ",
                                "-secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                " ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode searchhead",
                                " -site site1",
                                " -master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                " -secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                "\n",
                                "service splunk restart\n",
                                "/opt/aws/bin/cfn-signal -e $? --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " --resource OPSSearchHead2Instance",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "usermod --expiredate 1 splunk\n"
                            ]
                        ]
                    }
                },



        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "OPSSearchHead2NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "OPSSearchHead2EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }


                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2b-prd-splunk-ops-search-head-02-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk OPS Search Head"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },

    "OPSSearchHead2EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "300",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2b",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2b-prd-splunk-ops-search-head-02-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk OPS Search Head"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},

    "OPSSearchHead3NIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.6",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-ops-search-head-03-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk OPS Search Head"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
  "OPSSearchHead3Instance" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "c4.4xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                                "chmod 600 /var/log/cloud-init-output.log\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                                "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                                "export SPLUNK_USER=splunk\n",
                                "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                                "export SPLUNK_HOME=/opt/splunk\n",
                                "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkSHC3' >> /etc/hosts\n",
                                "hostname AWS-SplunkSHC3 \n",
                                "# Stop Splunk and reset password\n",
                                "service splunk stop\n",
                                "touch $SPLUNK_HOME/etc/.ui_login\n",
                                "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                                "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                " -role admin -auth admin:changeme\n",
                                "# Increase splunkweb connection timeout with splunkd\n",
                                "cat >$SPLUNK_HOME/etc/system/local/web.conf <<end\n",
                                "[settings]\n",
                                "splunkdConnectionTimeout = 300\n",
                                "end\n",
                                "# Configure some SHC parameters\n",
                                "cat >>$SPLUNK_HOME/etc/system/local/server.conf <<end\n",
                                "[shclustering]\n",
                                "register_replication_address = $LOCALIP\n",
                                "end\n",
                                "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local\n",
                                "service splunk start\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave ",
                                "-master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN init shcluster-config ",
                                "-mgmt_uri https://$LOCALIP:8089 -replication_port 8090 -replication_factor ",
                                {
                                    "Fn::FindInMap": [
                                        "SplunkConfig",
                                        "shcluster-replication-factor",
                                        "num"
                                    ]
                                },
                                " -conf_deploy_fetch_url https://",
                                {
                                    "Fn::GetAtt": [
                                        "DeploymentServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                "-shcluster_label SplunkSHC ",
                                "-secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                " ",
                                "-auth admin:",
                                {
                                    "Ref": "SplunkAdminPassword"
                                },
                                "\n",
                                "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode searchhead",
                                " -site site1",
                                " -master_uri https://",
                                {
                                    "Fn::GetAtt": [
                                        "ManagementServerInstance",
                                        "PrivateIp"
                                    ]
                                },
                                ":8089 ",
                                " -secret ",
                                {
                                    "Ref": "SplunkClusterSecret"
                                },
                                "\n",
                                "service splunk restart\n",
                                "/opt/aws/bin/cfn-signal -e $? --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " --resource OPSSearchHead3Instance",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "usermod --expiredate 1 splunk\n"
                            ]
                        ]
                    }
                },



        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "OPSSearchHead3NIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "OPSSearchHead3EBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }


                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-ops-search-head-03-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk OPS Search Head"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },



    "OPSSearchHead3EBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "300",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-ops-search-head-03-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk OPS Search Head"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },
                                                                                   {
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},

    "DeploymentServerNIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.7",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-deployment-server-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Deployment Server"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "DeploymentServerInstance" : {
      "Type" : "AWS::EC2::Instance",

       "DependsOn": "ManagementServerInstance",
      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "c4.2xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
             "Fn::Base64": {
                 "Fn::Join": [
                     "",
                     [
                         "#!/bin/bash -v\n",
                         "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                         "chmod 600 /var/log/cloud-init-output.log\n",
                         "yum update -y aws-cfn-bootstrap\n",
                         "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                         "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                         "export SPLUNK_USER=splunk\n",
                         "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                         "export SPLUNK_HOME=/opt/splunk\n",
                         "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkDeploy ' >> /etc/hosts\n",
                         "hostname AWS-SplunkDeploy \n",
                         "# Stop Splunk and reset password\n",
                         "service splunk stop\n",
                         "touch $SPLUNK_HOME/etc/.ui_login\n",
                         "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                         "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                         "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                         {
                             "Ref": "SplunkAdminPassword"
                         },
                         " -role admin -auth admin:changeme\n",
                         "# Increase splunkweb connection timeout with splunkd\n",
                         "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                         "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                         "[settings]\n",
                         "splunkdConnectionTimeout = 300\n",
                         "end\n",
                         "# Configure some SHC parameters\n",
                         "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/server.conf <<end\n",
                         "\n",
                         "[shclustering]\n",
                         "pass4SymmKey = ",
                         {
                             "Ref": "SplunkClusterSecret"
                         },
                         "\n",
                         "shcluster_label = SplunkSHC\n",
                         "end\n",
                         "# Forward to indexer cluster using indexer discovery\n",
                         "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/outputs.conf <<end\n",
                         "# Turn off indexing on the search head\n",
                         "[indexAndForward]\n",
                         "index = false\n",
                         "\n",
                         "[tcpout]\n",
                         "defaultGroup = indexer_cluster_peers\n",
                         "forwardedindex.filter.disable = true\n",
                         "indexAndForward = false\n",
                         "\n",
                         "[tcpout:indexer_cluster_peers]\n",
                         "autoLB = true\n",
                         "indexerDiscovery = cluster_master\n",
                         "\n",
                         "[indexer_discovery:cluster_master]\n",
                         "pass4SymmKey = ",
                         {
                             "Ref": "SplunkIndexerDiscoverySecret"
                         },
                         "\n",
                         "master_uri = https://",
                         {
                             "Fn::GetAtt": [
                                 "ManagementServerInstance",
                                 "PrivateIp"
                             ]
                         },
                         ":8089\n",
                         "end\n",
                         "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                         "# Add base config for search head cluster members\n",
                         "mkdir -p $SPLUNK_HOME/etc/shcluster/apps/member-base-autogenerated/local\n",
                         "cat >>$SPLUNK_HOME/etc/shcluster/apps/member-base-autogenerated/local/outputs.conf <<end\n",
                         "# Turn off indexing on the search head\n",
                         "[indexAndForward]\n",
                         "index = false\n",
                         "\n",
                         "[tcpout]\n",
                         "defaultGroup = indexer_cluster_peers\n",
                         "forwardedindex.filter.disable = true\n",
                         "indexAndForward = false\n",
                         "\n",
                         "[tcpout:indexer_cluster_peers]\n",
                         "autoLB = true\n",
                         "indexerDiscovery = cluster_master\n",
                         "\n",
                         "[indexer_discovery:cluster_master]\n",
                         "pass4SymmKey = ",
                         {
                             "Ref": "SplunkIndexerDiscoverySecret"
                         },
                         "\n",
                         "master_uri = https://",
                         {
                             "Fn::GetAtt": [
                                 "ManagementServerInstance",
                                 "PrivateIp"
                             ]
                         },
                         ":8089\n",
                         "end\n",

                         "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/shcluster/apps\n",
                         "service splunk start\n",
                         "sudo -u $SPLUNK_USER $SPLUNK_BIN edit licenser-localslave ",
                         "-master_uri https://",
                         {
                             "Fn::GetAtt": [
                                 "ManagementServerInstance",
                                 "PrivateIp"
                             ]
                         },
                         ":8089 ",
                         "-auth admin:",
                         {
                             "Ref": "SplunkAdminPassword"
                         },
                         "\n",
                         "sudo -u $SPLUNK_USER $SPLUNK_BIN apply shcluster-bundle -action stage --answer-yes\n",
                         "service splunk restart\n",
                         "/opt/aws/bin/cfn-signal -e $? --stack ",
                         {
                             "Ref": "AWS::StackName"
                         },
                         " --resource DeploymentServerInstance",
                         " --region ",
                         {
                             "Ref": "AWS::Region"
                         },
                         "\n",
                         "usermod --expiredate 1 splunk\n"
                     ]
                 ]
             }
         },

        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "DeploymentServerNIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "DeploymentServerEBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }

                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-deployment-server-01-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Deployment Server"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "DeploymentServerEBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "100",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-deployment-server-01-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Deployment Server"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},

    "ManagementServerNIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.8",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-mgmt-server-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Management Server"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "ManagementServerInstance" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "c4.2xlarge",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                  "Fn::Base64": {
                      "Fn::Join": [
                          "",
                          [
                              "#!/bin/bash -v\n",
                              "# First make clout-init output log readable by root only to protect sensitive parameter values\n",
                              "chmod 600 /var/log/cloud-init-output.log\n",
                              "yum update -y aws-cfn-bootstrap\n",
                              "export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)\n",
                              "export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null)\n",
                              "export SPLUNK_USER=splunk\n",
                              "export SPLUNK_BIN=/opt/splunk/bin/splunk\n",
                              "export SPLUNK_HOME=/opt/splunk\n",
                              "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkMST' >> /etc/hosts\n",
                              "hostname AWS-SplunkMST \n",
                              "# Stop Splunk and reset password\n",
                              "service splunk stop\n",
                              "touch $SPLUNK_HOME/etc/.ui_login\n",
                              "mv $SPLUNK_HOME/etc/passwd $SPLUNK_HOME/etc/passwd.bak\n",
                              "sed -i 's/force-change-pass true//' /etc/init.d/splunk\n",
                              "sudo -u $SPLUNK_USER $SPLUNK_BIN edit user admin -password ",
                              {
                                  "Ref": "SplunkAdminPassword"
                              },
                              " -role admin -auth admin:changeme\n",
                              "# Install files from the metadata\n",
                              "/opt/aws/bin/cfn-init -v ",
                              "         --stack ",
                              {
                                  "Ref": "AWS::StackName"
                              },
                              "         --resource ManagementServerInstance",
                              "         --region ",
                              {
                                  "Ref": "AWS::Region"
                              },
                              "\n",
                              "mkdir -p $SPLUNK_HOME/etc/licenses/enterprise\n",
                              "chown $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/licenses/enterprise\n",

                              "# Increase splunkweb connection timeout with splunkd\n",
                              "mkdir -p $SPLUNK_HOME/etc/apps/base-autogenerated/local\n",
                              "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/web.conf <<end\n",
                              "[settings]\n",
                              "splunkdConnectionTimeout = 300\n",
                              "end\n",
                              "# Forward to indexer cluster using indexer discovery\n",
                              "cat >>$SPLUNK_HOME/etc/apps/base-autogenerated/local/outputs.conf <<end\n",
                              "# Turn off indexing\n",
                              "[indexAndForward]\n",
                              "index = false\n",
                              "\n",
                              "[tcpout]\n",
                              "defaultGroup = indexer_cluster_peers\n",
                              "forwardedindex.filter.disable = true\n",
                              "indexAndForward = false\n",
                              "\n",
                              "[tcpout:indexer_cluster_peers]\n",
                              "autoLB = true\n",
                              "indexerDiscovery = cluster_master\n",
                              "\n",
                              "[indexer_discovery:cluster_master]\n",
                              "pass4SymmKey = ",
                              {
                                  "Ref": "SplunkIndexerDiscoverySecret"
                              },
                              "\n",
                              "master_uri = https://127.0.0.1:8089\n",
                              "end\n",
                              "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/apps/base-autogenerated\n",
                              "service splunk start\n",
                              "sudo -u $SPLUNK_USER $SPLUNK_BIN login -auth admin:",
                              {
                                  "Ref": "SplunkAdminPassword"
                              },
                              "\n",
                              "sudo -u $SPLUNK_USER $SPLUNK_BIN edit cluster-config -mode master -multisite true",
                              " -available_sites ",
                              {
                                  "Fn::If": [
                                      "Create2AZ",
                                      "site1,site2,",
                                      "site1,site2,site3"
                                  ]
                              },
                              " -site site1",
                              " -site_replication_factor origin:1,total:",
                              {
                                  "Ref": "SplunkReplicationFactor"
                              },
                              " -site_search_factor origin:1,total:2",
                              " -secret ",
                              {
                                  "Ref": "SplunkClusterSecret"
                              },
                              " -cluster_label SplunkIndexers",
                              "\n",
                              "# Configure indexer discovery\n",
                              "cat >>$SPLUNK_HOME/etc/system/local/server.conf <<end\n",
                              "\n",
                              "[indexer_discovery]\n",
                              "pass4SymmKey = ",
                              {
                                  "Ref": "SplunkIndexerDiscoverySecret"
                              },
                              "\n",
                              "indexerWeightByDiskCapacity = true\n",
                              "end\n",
                              "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local/server.conf\n",
                              "# Add base configs for peer nodes as an app under master-apps\n",
                              "# Peer config 1: Enable HEC input\n",
                              "sudo -u $SPLUNK_USER $SPLUNK_BIN http-event-collector enable -uri https://localhost:8089\n",
                              "sudo -u $SPLUNK_USER $SPLUNK_BIN http-event-collector create default-token -uri https://localhost:8089 > /tmp/token\n",
                              "TOKEN=`sed -n 's/\\ttoken=//p' /tmp/token` && rm /tmp/token\n",
                              "echo $TOKEN\n",
                              "mkdir -p $SPLUNK_HOME/etc/master-apps/peer-base-autogenerated/local\n",
                              "mv $SPLUNK_HOME/etc/apps/splunk_httpinput/local/inputs.conf $SPLUNK_HOME/etc/master-apps/peer-base-autogenerated/local\n",
                              "# Peer config 2: Enable splunktcp input\n",
                              "cat >>$SPLUNK_HOME/etc/master-apps/peer-base-autogenerated/local/inputs.conf <<end\n",
                              "\n",
                              "[splunktcp://9997]\n",
                              "disabled=0\n",
                              "end\n",

                              "chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/master-apps\n",
                              "service splunk restart\n",
                              "/opt/aws/bin/cfn-signal -e $? --stack ",
                              {
                                  "Ref": "AWS::StackName"
                              },
                              " --resource ManagementServerInstance",
                              " --region ",
                              {
                                  "Ref": "AWS::Region"
                              },
                              "\n",

                              "'\n",
                              "usermod --expiredate 1 splunk\n"
                          ]
                      ]
                  }
              },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "ManagementServerNIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "ManagementServerEBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }


                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-mgmt-server-01-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Management Server"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },



    "ManagementServerEBSvolume": {
			"Type": "AWS::EC2::Volume",
			"Properties": {
				"AutoEnableIO": "True",
				"Size": "100",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-mgmt-server-01-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Management Server"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },{
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


			}
		},

    "ConfigurationUtilityServerNIC" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
       "SubnetId" : "subnet-ed579e94",
       "PrivateIpAddress": "10.219.19.9",
       "GroupSet" : ["sg-867d07f9"],
       "Tags": [{
               "Key": "Name",
               "Value": "stx-uw2-2a-prd-splunk-config-utility-server-01-ec2-nic-1"
       },

                   {
                           "Key": "ApplicationRole",
                           "Value": "Splunk Configuration/Utility Server"
                         },
                         {
                                 "Key": "Cluster",
                                 "Value": "NA"
                               },
                               {
                                       "Key": "Environment",
                                       "Value": "Production"
                                     },
                                     {
                                             "Key": "Version",
                                             "Value": "6.6.2"
                                           },
                                          {
                                                   "Key": "OperatingSystem",
                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                 },
                                                 {
                                                         "Key": "Owner",
                                                         "Value": "Kevin McLellan"
                                                       },
                                                       {
                                                               "Key": "BusinessUnit",
                                                               "Value": "NA"
                                                             },
                                                             {
                                                                     "Key": "Compliance",
                                                                     "Value": "NA"
                                                                   },{
                                                                           "Key": "Backup",
                                                                           "Value": "False"
                                                                         }

                 ]

     }
   },
    "ConfigurationUtilityServerInstance" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {

        "KeyName" : { "Ref" : "KeyName" },

        "ImageId" : "ami-79658101",

        "InstanceType" : "t2.medium",

        "Tenancy" :{"Ref" : "InstanceTenancy"},



        "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/xvda",
                  "Ebs" : {
                     "VolumeType" : "gp2",

                     "VolumeSize" : "80"
                  }
               }

            ],
            "UserData": {
                  "Fn::Base64": {
                      "Fn::Join": [
                          "",
                          [
                              "#!/bin/bash -v\n",

                              "printf '%s\t%s\n' \"$LOCALIP\" 'AWS-SplunkConfig' >> /etc/hosts\n",
                              "hostname AWS-SplunkConfig \n",

                          ]
                      ]
                  }
              },


        "NetworkInterfaces" : [{ "NetworkInterfaceId" : { "Ref" : "ConfigurationUtilityServerNIC" }, "DeviceIndex" : "0" }
                                      ],
                                      "Volumes" : [

                                                              {
                                                                      "VolumeId" : { "Ref" : "ConfigurationUtilityServerEBSvolume" },
                                                                      "Device" :  "/dev/sdb"
                                                              }


                                                      ],

                                                        "Tags": [{
                                                                                          "Key": "Name",
                                                                                          "Value": "stx-uw2-2a-prd-splunk-config-utility-server-01-ec2"
                                                                                  },
                                                                                  {
                                                                                          "Key": "ApplicationRole",
                                                                                          "Value": "Splunk Configuration/Utility Server"
                                                                                        },
                                                                                        {
                                                                                                "Key": "Cluster",
                                                                                                "Value": "NA"
                                                                                              },
                                                                                              {
                                                                                                      "Key": "Environment",
                                                                                                      "Value": "Production"
                                                                                                    },
                                                                                                    {
                                                                                                            "Key": "Version",
                                                                                                            "Value": "6.6.2"
                                                                                                          },
                                                                                                         {
                                                                                                                  "Key": "OperatingSystem",
                                                                                                                  "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                                                                },
                                                                                                                {
                                                                                                                        "Key": "Owner",
                                                                                                                        "Value": "Kevin McLellan"
                                                                                                                      },
                                                                                                                      {
                                                                                                                              "Key": "BusinessUnit",
                                                                                                                              "Value": "NA"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                    "Key": "Compliance",
                                                                                                                                    "Value": "NA"
                                                                                                                                  },{
                                                                                                                                          "Key": "Backup",
                                                                                                                                          "Value": "False"
                                                                                                                                        }

                                                                                ]

    }
  },


    "ConfigurationUtilityServerEBSvolume": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AutoEnableIO": "True",
        "Size": "100",
         "VolumeType" :"gp2",

         "AvailabilityZone": "us-west-2a",
         "Tags": [{
                                           "Key": "Name",
                                           "Value": "stx-uw2-2a-prd-splunk-config-utility-server-01-ec2-rootebsvol"
                                   },
                                   {
                                           "Key": "ApplicationRole",
                                           "Value": "Splunk Management Server"
                                         },
                                         {
                                                 "Key": "Cluster",
                                                 "Value": "NA"
                                               },
                                               {
                                                       "Key": "Environment",
                                                       "Value": "Production"
                                                     },
                                                     {
                                                             "Key": "Version",
                                                             "Value": "6.6.2"
                                                           },
                                                          {
                                                                   "Key": "OperatingSystem",
                                                                   "Value": "Linux/Unix, Amazon Linux 2015.05.04"
                                                                 },
                                                                 {
                                                                         "Key": "Owner",
                                                                         "Value": "Kevin McLellan"
                                                                       },
                                                                       {
                                                                               "Key": "BusinessUnit",
                                                                               "Value": "NA"
                                                                             },
                                                                             {
                                                                                     "Key": "Compliance",
                                                                                     "Value": "NA"
                                                                                   },
                                                                                   {
                                                                                           "Key": "Backup",
                                                                                           "Value": "False"
                                                                                         }

                                 ]


      }
    }

}
}
